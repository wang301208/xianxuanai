version: "3.9"

x-healthcheck-defaults: &healthcheck_defaults
  interval: 30s
  timeout: 5s
  retries: 5
  start_period: 20s

services:
  neo4j:
    image: ${NEO4J_IMAGE:-neo4j:5.21.0}
    restart: unless-stopped
    env_file:
      - ./env/.env.prod
    environment:
      NEO4J_AUTH: ${NEO4J_AUTH:-neo4j/pleaseletmein}
      NEO4J_server_memory_pagecache_size: ${NEO4J_PAGECACHE_SIZE:-2G}
      NEO4J_server_memory_heap_initial__size: ${NEO4J_HEAP_INITIAL:-1G}
      NEO4J_server_memory_heap_max__size: ${NEO4J_HEAP_MAX:-1G}
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474"
      - "${NEO4J_BOLT_PORT:-7687}:7687"
    volumes:
      - neo4j-data:/data
    networks:
      - skills-net
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474/ || exit 1"]
      <<: *healthcheck_defaults

  qdrant:
    image: ${QDRANT_IMAGE:-qdrant/qdrant:v1.10.1}
    restart: unless-stopped
    env_file:
      - ./env/.env.prod
    environment:
      QDRANT__SERVICE__GRPC_PORT: ${QDRANT_GRPC_PORT:-6334}
      QDRANT__SERVICE__HTTP_PORT: ${QDRANT_HTTP_PORT:-6333}
    ports:
      - "${QDRANT_HTTP_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - skills-net
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:6333/healthz || exit 1"]
      <<: *healthcheck_defaults

  skill-gateway:
    build:
      context: ..
      dockerfile: deploy/local/skill-gateway.Dockerfile
    image: ${SKILL_GATEWAY_IMAGE:-skill-gateway}:${SKILL_GATEWAY_TAG:-latest}
    restart: unless-stopped
    env_file:
      - ./env/.env.prod
    environment:
      PORT: ${SKILL_GATEWAY_PORT:-8300}
      GATEWAY_REQUIRE_AUTH: ${GATEWAY_REQUIRE_AUTH:-true}
      GATEWAY_REQUIRE_TENANT_HEADER: ${GATEWAY_REQUIRE_TENANT_HEADER:-true}
    depends_on:
      neo4j:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    ports:
      - "${SKILL_GATEWAY_PORT:-8300}:8300"
    networks:
      - skills-net
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import os, urllib.request; urllib.request.urlopen('http://127.0.0.1:' + os.environ.get('PORT', '8300') + '/readyz')\"",
        ]
      <<: *healthcheck_defaults

  autogpt-agent:
    build:
      context: ..
      dockerfile: Dockerfile
    image: ${AUTOGPT_IMAGE:-autogpt}:${AUTOGPT_TAG:-latest}
    restart: unless-stopped
    depends_on:
      skill-gateway:
        condition: service_healthy
    env_file:
      - ./env/.env.prod
    environment:
      SKILL_RPC_BASE_URL: ${SKILL_RPC_BASE_URL:-http://skill-gateway:8300}
      PORT: ${AUTOGPT_PORT:-8000}
    volumes:
      - autogpt-data:/app/data
    ports:
      - "${AUTOGPT_PORT:-8000}:8000"
    networks:
      - skills-net

networks:
  skills-net:
    driver: bridge

volumes:
  neo4j-data:
  qdrant-data:
  autogpt-data:
